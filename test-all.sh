#!/bin/bash

echo "üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ Ziggler.kz"
echo "=================================="

# –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
echo "üì¶ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
npm test

if [ $? -eq 0 ]; then
    echo "‚úÖ Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"

    # –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    echo "üåê –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤..."

    # –ó–∞–ø—É—Å–∫ dev server –≤ —Ñ–æ–Ω–µ –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤
    npm run dev > /dev/null 2>&1 &
    DEV_PID=$!
    echo "üöÄ Dev server –∑–∞–ø—É—â–µ–Ω (PID: $DEV_PID)"

    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    sleep 5

    # –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤
    npx playwright test --project=chromium --timeout=30000

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dev server
    kill $DEV_PID 2>/dev/null || true
    echo "üõë Dev server –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

    if [ $? -eq 0 ]; then
        echo "‚úÖ E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
        echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ùå E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
        exit 1
    fi
else
    echo "‚ùå Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
    exit 1
fi
